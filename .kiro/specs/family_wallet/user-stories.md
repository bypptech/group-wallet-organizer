# Family Shared Wallet - ユーザーストーリー集

## 概要

Family Shared Wallet システムの主要ユーザーストーリーをロール別に整理し、優先度と実装状況を明確化したドキュメント。

## ロール定義 🔵

### Requester (リクエスター)
家族メンバーや組織の一般メンバー。支出や操作のリクエストを作成し、承認を待つ役割。

### Approver (承認者)
承認権限を持つメンバー。ポリシーに基づいてエスクローを承認・拒否する役割。

### Owner (オーナー)
システム管理者権限を持つメンバー。ポリシー設定、メンバー管理、システム設定を行う役割。

### Viewer (閲覧者)
読み取り専用アクセス権を持つメンバー。監査ログや履歴の閲覧のみ可能。

---

## エスクロー管理機能

### US-001: エスクロー作成 🔵
**As a** Requester
**I want to** 支出や資金移動のリクエストをエスクローとして作成する
**So that** 家族・組織内で承認プロセスを経て安全に実行できる

**受け入れ基準**:
- ✅ 4ステップウィザード（概要・支払い詳細・実行先・確認）で作成 🔵
- ✅ Paymaster スポンサーシップ チェック結果の表示 🔵
- ✅ テンプレート機能（過去エスクローからの複製） 🟡
- ✅ リアルタイム入力検証とポリシー違反チェック 🔵

**実装状況**: ✅ 基本機能実装済み、スポンサーシップ統合は部分実装

### US-002: エスクロー承認 🔵
**As an** Approver
**I want to** 承認キューのエスクローを確認し、承認・拒否を行う
**So that** ポリシーに従った適切な資金管理ができる

**受け入れ基準**:
- ✅ 承認待ち一覧の表示 🔵
- ✅ 閾値進捗とタイムライン表示 🔵
- ✅ Proof 入力と確認モーダル 🔵
- ✅ 承認後のタイムロック確認 🔵

**実装状況**: ✅ 基本機能実装済み、UserOperation 統合は部分実装

### US-003: エスクロー監査 🔵
**As a** Viewer
**I want to** エスクローの履歴と監査ログを確認する
**So that** 透明性のある資金管理状況を把握できる

**受け入れ基準**:
- ✅ 基本情報とタイムライン表示 🔵
- ✅ UserOperation ハッシュとPaymasterレスポンス表示 🟡
- ✅ フィルタリング機能（Vault/Escrow/日付範囲） 🔵
- ✅ CSV/JSON エクスポート機能 🟡

**実装状況**: ✅ UI実装済み、ブロックチェーン統合は部分実装

---

## ロール・権限管理機能

### US-004: メンバー管理 🔵
**As an** Owner
**I want to** vault メンバーの追加・削除・ロール変更を行う
**So that** 適切なアクセス制御を維持できる

**受け入れ基準**:
- ✅ メンバーリストと役割タグ表示 🔵
- ✅ 招待リンク生成機能 🟡
- ✅ ロール変更とMerkle proof更新 🟡
- ✅ アクセス権限の即座反映 🟡

**実装状況**: 🔴 UI基盤のみ、スマートコントラクト統合未完了

### US-005: ポリシー設定 🔵
**As an** Owner
**I want to** 承認閾値、タイムロック、実行権限を設定する
**So that** 組織のガバナンス要件に合わせたポリシーを適用できる

**受け入れ基準**:
- ✅ ポリシー一覧グリッド表示 🔵
- ✅ 閾値・タイムロック・rolesRoot設定 🟡
- ✅ スケジュール更新・ファイナライズフロー 🔴
- ✅ Guardian緊急操作機能 🔴

**実装状況**: 🔴 PolicyManager スマートコントラクト未実装

### US-006: 権限検証 🔵
**As a** システム
**I want to** Merkle proof を使用してオンチェーン権限検証を行う
**So that** 偽装できない権限制御を実現できる

**受け入れ基準**:
- ✅ RoleVerifier コントラクトでの検証 🔴
- ✅ Merkle proof 生成とクライアント統合 🔴
- ✅ 権限検証失敗時の適切なエラー表示 🟡
- ✅ ロール変更時のproof更新 🔴

**実装状況**: 🔴 RoleVerifier 実装未完了

---

## Account Abstraction 機能

### US-007: ガススポンサーシップ 🔵
**As a** Requester
**I want to** USDC/JPYCでガス代を支払う
**So that** ETHを持たずにシームレスな操作ができる

**受け入れ基準**:
- ✅ Paymaster eligibility チェック 🟡
- ✅ スポンサーシップ結果の事前表示 🟡
- ✅ 失敗時のフォールバック案内 🟡
- ✅ 日次上限と残高監視 🔴

**実装状況**: 🔴 ERC20Paymaster 未実装

### US-008: UserOperation 処理 🔵
**As a** システム
**I want to** ERC-4337準拠のバッチ取引を実行する
**So that** 効率的でガスレスな取引体験を提供できる

**受け入れ基準**:
- ✅ UserOperation 生成と署名 🟡
- ✅ Bundler への送信と処理追跡 🟡
- ✅ EntryPoint経由の実行 🟡
- ✅ 監査ログへの記録 🟡

**実装状況**: 🟡 基本フロー実装中、統合テスト未完了

### US-009: Paymaster 管理 🔵
**As an** Owner
**I want to** Paymaster の残高と設定を管理する
**So that** 安定したガススポンサーシップを維持できる

**受け入れ基準**:
- ✅ 残高・日次消費率・フォールバック設定表示 🔴
- ✅ 自動補充とアラート機能 🔴
- ✅ スポンサーシップポリシーの設定 🔴
- ✅ 利用統計とコスト分析 🔴

**実装状況**: 🔴 Paymaster インフラ未構築

---

## 通知・コミュニケーション機能

### US-010: プッシュ通知 🔵
**As a** メンバー
**I want to** 承認待ち、期限切れ、システム変更の通知を受け取る
**So that** 迅速な対応と情報共有ができる

**受け入れ基準**:
- ✅ Web Push と Expo Push の両対応 🔵
- ✅ 通知センターでの分類表示（全体/自分宛/システム） 🔵
- ✅ 端末ごとの通知設定管理 🟡
- ✅ 配信成功率の監視 🟡

**実装状況**: ✅ 基本実装済み、配信最適化は継続改善中

### US-011: 通知設定管理 🔵
**As a** メンバー
**I want to** 通知の種類、頻度、配信方法を設定する
**So that** 自分の作業フローに合った通知を受け取れる

**受け入れ基準**:
- ✅ Web Push 有効化スイッチ 🔵
- ✅ 登録済み端末リスト表示 🔵
- ✅ Expo トークン登録状況と同期日時 🔵
- ✅ 通知カテゴリ別の ON/OFF 設定 🟡

**実装状況**: ✅ 基本機能実装済み

### US-012: リアルタイム更新 🔵
**As a** メンバー
**I want to** エスクロー状態の変更をリアルタイムで確認する
**So that** 最新の状況を常に把握できる

**受け入れ基準**:
- ✅ The Graph サブグラフからの即座更新 🟡
- ✅ WebSocket またはポーリングによる状態同期 🟡
- ✅ UI への楽観的更新適用 🔵
- ✅ ネットワーク障害時の復旧処理 🟡

**実装状況**: 🟡 The Graph 統合は部分実装、リアルタイム性改善中

---

## マルチプラットフォーム UX

### US-013: レスポンシブ Web UI 🔵
**As a** Web ユーザー
**I want to** Desktop/Tablet/Mobile で一貫した操作体験を得る
**So that** どのデバイスからでも効率的に作業できる

**受け入れ基準**:
- ✅ Desktop: 左サイドバー + メインコンテンツ（1440px） 🔵
- ✅ Tablet: 収納サイドバー + トップナビ（1024px） 🔵
- ✅ Mobile: Bottom Tabs + Top App Bar（375px） 🔵
- ✅ ロール別 UI 差分の適切な表示 🔵

**実装状況**: ✅ 基本レイアウト実装済み、細かな調整継続中

### US-014: モバイルアプリ体験 🔵
**As a** モバイルユーザー
**I want to** ネイティブ機能を活用した便利な操作を行う
**So that** 外出先でも迅速な承認・確認ができる

**受け入れ基準**:
- ✅ QR スキャンによる承認フロー 🟡
- ✅ プッシュ通知からの直接アクション 🔵
- ✅ オフライン対応とデータ同期 🔴
- ✅ 生体認証連携 🔴

**実装状況**: 🟡 基本アプリ構造実装済み、ネイティブ機能統合は部分実装

### US-015: ウォレット接続管理 🔵
**As a** ユーザー
**I want to** WalletConnect を使用して安全にウォレットを接続する
**So that** 秘密鍵を共有せずに認証・署名ができる

**受け入れ基準**:
- ✅ WalletConnect v2 Modal 統合 🔵
- ✅ セッション管理と自動再接続 🔵
- ✅ Base ネットワーク切り替え案内 🔵
- ✅ 複数ウォレット対応 🟡

**実装状況**: ✅ 基本機能実装済み

---

## 開発・運用支援機能

### US-016: 監査ログ機能 🔵
**As a** 監査担当者
**I want to** 全ての操作履歴を詳細に確認・エクスポートする
**So that** コンプライアンス要件を満たし、問題調査ができる

**受け入れ基準**:
- ✅ 操作種別・ユーザー・タイムスタンプの記録 🔵
- ✅ Transaction Hash との紐付け 🟡
- ✅ フィルタリングと検索機能 🔵
- ✅ CSV/JSON 形式でのエクスポート 🟡

**実装状況**: ✅ 基本機能実装済み、ブロックチェーン統合改善中

### US-017: システム監視 🔵
**As an** Owner
**I want to** Paymaster残高、API稼働状況、通知配信率を監視する
**So that** システムの健全性を保ち、問題を早期発見できる

**受け入れ基準**:
- ✅ KPI ダッシュボード表示 🟡
- ✅ アラート機能としきい値設定 🔴
- ✅ 外部サービス依存の監視 🔴
- ✅ パフォーマンス指標の可視化 🔴

**実装状況**: 🔴 監視インフラ未構築

### US-018: 開発支援機能 🔵
**As a** 開発者
**I want to** Tsumiki フレームワークを使用して効率的に開発・保守する
**So that** 仕様と実装の整合性を保ち、品質を向上できる

**受け入れ基準**:
- ✅ @kairo-* コマンドでの要件→設計→実装フロー 🔵
- ✅ @tdd-* コマンドでのテスト駆動開発 🔵
- ✅ @rev-* コマンドでの逆生成・棚卸し 🔵
- ✅ CI/CD との統合と自動品質チェック 🟡

**実装状況**: ✅ フレームワーク構築済み、継続改善中

---

## 優先度マトリックス

| 機能カテゴリ | High Priority 🔵 | Medium Priority 🟡 | Low Priority 🔴 |
|-------------|------------------|-------------------|-----------------|
| **エスクロー管理** | US-001, US-002, US-003 | テンプレート機能 | 高度な承認フロー |
| **権限管理** | US-006 権限検証 | US-004 メンバー管理 | US-005 ポリシー設定 |
| **Account Abstraction** | US-008 UserOperation | US-007 ガススポンサー | US-009 Paymaster管理 |
| **通知** | US-010, US-011 | US-012 リアルタイム更新 | 高度な通知フィルタ |
| **UI/UX** | US-013, US-015 | US-014 モバイル機能 | アクセシビリティ強化 |
| **運用** | US-016 監査ログ | US-018 開発支援 | US-017 システム監視 |

---

**信頼性指標**:
- 🔵 高信頼性: 実装済み、テスト済み、または明確に定義されたストーリー
- 🟡 中信頼性: 部分実装、仕様が明確、または技術的検証が必要なストーリー
- 🔴 低信頼性: 未実装、仕様不明確、または技術的課題があるストーリー

**最終更新**: 2025-09-29
**承認者**: [要承認]
**次回レビュー**: kairo-design 完了後