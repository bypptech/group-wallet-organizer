# Family Shared Wallet - 受け入れ基準詳細

## 概要

Family Shared Wallet システムの全機能要件に対する詳細な受け入れ基準を EARS (Easy Approach to Requirements Syntax) 形式で定義。各基準には実装状況と信頼性指標を付与。

---

## エスクロー管理システム

### AC-ESC-001: エスクロー作成フロー 🔵

#### AC-ESC-001-1: 基本作成フロー
**WHEN** Requester ロールのユーザーがエスクロー作成ボタンをクリックする
**THEN** システム SHALL 4ステップウィザード（概要・支払い詳細・実行先・確認）を表示する 🔵

**WHEN** ユーザーが概要ステップで必須項目（金額、説明）を入力する
**THEN** システム SHALL 入力値をリアルタイム検証し、ポリシー制約違反があれば警告を表示する 🔵

**WHEN** ユーザーが支払い詳細ステップでトークンと金額を設定する
**THEN** システム SHALL Paymaster スポンサーシップ eligibility をチェックし、結果を表示する 🟡

**WHEN** ユーザーが実行先ステップで target contract と callData を設定する
**THEN** システム SHALL コントラクト検証を実行し、安全性警告を表示する 🟡

**WHEN** ユーザーが確認ステップでエスクロー作成を確定する
**THEN** システム SHALL EscrowRegistry.createEscrow を呼び出し、ユニークなescrowIdを生成する 🔵

#### AC-ESC-001-2: スポンサーシップ統合
**WHEN** Paymaster スポンサーシップ チェックが成功する
**THEN** システム SHALL 「ガス代無料」表示と推定実行時間を提示する 🟡

**WHEN** Paymaster スポンサーシップ チェックが失敗する
**THEN** システム SHALL 失敗理由（残高不足/上限超過/未対応トークン）とフォールバック手順を表示する 🟡

**WHEN** ユーザーが ETH によるガス支払いを選択する
**THEN** システム SHALL 推定ガス量と ETH 必要量を計算し、ウォレット残高と比較する 🔵

#### AC-ESC-001-3: テンプレート機能
**WHEN** ユーザーが過去のエスクローからテンプレート作成を選択する
**THEN** システム SHALL フォーム項目を自動入力し、編集可能状態で表示する 🟡

**WHEN** ユーザーがテンプレートを保存する
**THEN** システム SHALL ユーザー固有のテンプレートとして永続化し、次回作成時に選択可能にする 🟡

**実装状況**: ✅ 基本フロー実装済み、スポンサーシップ統合は50%完了、テンプレート機能は未実装

### AC-ESC-002: エスクロー承認フロー 🔵

#### AC-ESC-002-1: 承認キュー表示
**WHEN** Approver ロールのユーザーがダッシュボードにアクセスする
**THEN** システム SHALL 承認待ちエスクロー一覧を優先度順（期限切れ近→新規）で表示する 🔵

**WHEN** 承認待ちエスクローが表示される
**THEN** システム SHALL 各項目に現在の承認数/必要承認数、残り時間、金額、リクエスター名を表示する 🔵

**WHEN** ユーザーが特定のエスクローを選択する
**THEN** システム SHALL 詳細情報、ポリシー設定、承認履歴、タイムラインを表示する 🔵

#### AC-ESC-002-2: 承認実行フロー
**WHEN** Approver がエスクロー承認ボタンをクリックする
**THEN** システム SHALL Merkle proof 入力フィールドと承認確認モーダルを表示する 🟡

**WHEN** 有効な Merkle proof が入力される
**THEN** システム SHALL RoleVerifier で権限検証を実行し、成功時に UserOperation を生成する 🔴

**WHEN** UserOperation が Bundler に送信される
**THEN** システム SHALL トランザクション追跡 ID を表示し、承認状態を「処理中」に更新する 🟡

**WHEN** 承認が成功する
**THEN** システム SHALL approvalStates を更新し、閾値到達チェックを実行する 🔵

#### AC-ESC-002-3: 閾値とタイムロック管理
**WHEN** 必要承認数に達する
**THEN** システム SHALL タイムロック期間を確認し、実行可能時刻を計算・表示する 🔵

**WHEN** タイムロック期間が経過していない
**THEN** システム SHALL 「タイムロック中」状態でカウントダウンタイマーを表示する 🔵

**WHEN** タイムロック期間が経過する
**THEN** システム SHALL Owner ロールユーザーに実行権限を付与し、通知を送信する 🟡

**実装状況**: ✅ 基本UI実装済み、スマートコントラクト統合は30%完了、自動実行機能は未実装

### AC-ESC-003: エスクロー実行・キャンセル 🔵

#### AC-ESC-003-1: エスクロー実行
**WHEN** Owner ロールのユーザーがタイムロック経過後のエスクローを実行する
**THEN** システム SHALL EscrowRegistry.release を呼び出し、資産移転またはコール実行を行う 🟡

**WHEN** 実行対象が外部コントラクトの場合
**THEN** システム SHALL callData を target に送信し、実行結果を記録する 🟡

**WHEN** 実行対象が資産移転の場合
**THEN** システム SHALL 指定トークンを payee に送金し、残高を更新する 🔵

**WHEN** 実行が完了する
**THEN** システム SHALL エスクロー状態を「RELEASED」に更新し、全メンバーに通知する 🔵

#### AC-ESC-003-2: エスクロー キャンセル
**WHEN** Payer または Guardian がエスクローキャンセルを要求する
**THEN** システム SHALL キャンセル権限を検証し、必要に応じて承認フローを開始する 🟡

**WHEN** 期限切れのエスクローが検出される
**THEN** システム SHALL 自動的に「EXPIRED」状態に移行し、資産を Payer に返還する 🔵

**WHEN** 緊急キャンセルが実行される
**THEN** システム SHALL Guardian 権限を検証し、即座にキャンセル処理を実行する 🔴

**実装状況**: 🟡 基本ロジック実装済み、スマートコントラクト統合と緊急処理は部分実装

---

## ロール・権限管理システム

### AC-ROLE-001: ロール派生システム 🔵

#### AC-ROLE-001-1: ロール計算ロジック
**WHEN** システムが vault メンバー情報を処理する
**THEN** システム SHALL ROLE_PRIORITY 配列に基づいて最高権限ロールを導出する 🔵

**WHEN** ユーザーが複数ロール（'requester', 'approver'）を持つ
**THEN** システム SHALL 'approver' を優先し、派生ロールとして返す 🔵

**WHEN** ユーザーが vault メンバーでない
**THEN** システム SHALL 'viewer' ロールを返し、読み取り専用権限を付与する 🔵

#### AC-ROLE-001-2: 権限検証
**WHEN** ユーザーが権限必要な操作を実行する
**THEN** システム SHALL 現在の派生ロールと必要権限レベルを比較し、アクセス可否を判定する 🔵

**WHEN** 権限不足の操作が試行される
**THEN** システム SHALL 適切なエラーメッセージを表示し、必要権限レベルを案内する 🔵

**実装状況**: ✅ ロジック実装済み、全テスト通過、本格運用準備完了

### AC-ROLE-002: Merkle Proof 権限検証 🔴

#### AC-ROLE-002-1: Proof生成
**WHEN** ユーザーが権限証明が必要な操作を開始する
**THEN** システム SHALL current roles から Merkle leaf を生成し、proof を計算する 🔴

**WHEN** rolesRoot が更新される
**THEN** システム SHALL 全ユーザーの proof を再生成し、キャッシュを更新する 🔴

#### AC-ROLE-002-2: オンチェーン検証
**WHEN** 生成された proof が RoleVerifier に送信される
**THEN** システム SHALL verifyRole 関数で Merkle proof を検証し、結果を返す 🔴

**WHEN** 検証が失敗する
**THEN** システム SHALL 「PolicyMismatch」エラーでトランザクションをリバートする 🔴

**実装状況**: 🔴 RoleVerifier コントラクト未実装、クライアント統合未着手

### AC-ROLE-003: メンバー管理機能 🟡

#### AC-ROLE-003-1: メンバー追加・削除
**WHEN** Owner がメンバー招待を実行する
**THEN** システム SHALL 招待リンクを生成し、有効期限と制約を設定する 🟡

**WHEN** 被招待者が招待リンクにアクセスする
**THEN** システム SHALL vault 情報を表示し、参加確認フローを開始する 🟡

**WHEN** メンバー追加が確定する
**THEN** システム SHALL vault_members テーブルを更新し、rolesRoot を再計算する 🟡

#### AC-ROLE-003-2: ロール変更
**WHEN** Owner が既存メンバーのロールを変更する
**THEN** システム SHALL 変更履歴を記録し、影響範囲を算出・表示する 🟡

**WHEN** ロール変更が保存される
**THEN** システム SHALL 新しい rolesRoot を生成し、ポリシー更新フローを開始する 🟡

**実装状況**: 🟡 UI基盤実装済み、バックエンド連携と暗号学的処理は部分実装

---

## Account Abstraction システム

### AC-AA-001: Paymaster 統合 🔴

#### AC-AA-001-1: スポンサーシップ判定
**WHEN** ユーザーが UserOperation を準備する
**THEN** システム SHALL ERC20Paymaster の validatePaymasterUserOp を呼び出し、eligibility を確認する 🔴

**WHEN** 指定トークンの残高が不足している
**THEN** システム SHALL 「UnsupportedToken」または「SponsorshipDenied」エラーを返す 🔴

**WHEN** 日次消費上限を超過している
**THEN** システム SHALL 「ExceededSpendLimit」エラーと復旧時刻を返す 🔴

#### AC-AA-001-2: ガス代計算・支払い
**WHEN** スポンサーシップが承認される
**THEN** システム SHALL 必要なトークン量を計算し、Paymaster 経由で徴収する 🔴

**WHEN** Paymaster の postOp が実行される
**THEN** システム SHALL 実際のガス消費量に基づいて過不足を調整する 🔴

**実装状況**: 🔴 ERC20Paymaster 未実装、テストネット検証未実施

### AC-AA-002: UserOperation フロー 🟡

#### AC-AA-002-1: UO生成と署名
**WHEN** ユーザーが承認操作を実行する
**THEN** システム SHALL permissionless SDK を使用して UserOperation を構築する 🟡

**WHEN** UserOperation が完成する
**THEN** システム SHALL WalletConnect 経由でユーザー署名を要求する 🟡

**WHEN** 署名が完了する
**THEN** システム SHALL 署名付き UserOperation を Bundler に送信する 🟡

#### AC-AA-002-2: 実行追跡
**WHEN** UserOperation が Bundler で処理される
**THEN** システム SHALL operation hash を追跡し、状態変化を監視する 🟡

**WHEN** EntryPoint で実行が完了する
**THEN** システム SHALL transaction receipt を取得し、ガス消費量と結果を記録する 🟡

**実装状況**: 🟡 基本フロー実装中、エラーハンドリングと監視機能は部分実装

---

## 通知システム

### AC-NOTIF-001: プッシュ通知配信 🔵

#### AC-NOTIF-001-1: 通知トリガー
**WHEN** エスクローの状態が変化する（作成/承認/実行/キャンセル）
**THEN** システム SHALL 関連メンバーに対象通知を即座に送信する 🔵

**WHEN** 承認期限が24時間以内に迫る
**THEN** システム SHALL Approver ロールメンバーに緊急通知を送信する 🔵

**WHEN** Paymaster 残高が閾値を下回る
**THEN** システム SHALL Owner ロールメンバーにアラート通知を送信する 🟡

#### AC-NOTIF-001-2: マルチチャネル配信
**WHEN** 通知が生成される
**THEN** システム SHALL Web Push と Expo Push の両チャネルで並行配信する 🔵

**WHEN** 配信に失敗する
**THEN** システム SHALL 指数バックオフでリトライし、3回失敗後は端末を非アクティブ化する 🟡

**WHEN** 配信成功率が80%を下回る
**THEN** システム SHALL 管理者にアラートし、配信インフラの健全性チェックを実行する 🟡

**実装状況**: ✅ 基本配信実装済み、配信監視とリトライ機能は改善継続中

### AC-NOTIF-002: 通知管理機能 🔵

#### AC-NOTIF-002-1: 通知センター
**WHEN** ユーザーが通知センターにアクセスする
**THEN** システム SHALL 全体/自分宛/システムの3タブで通知を分類表示する 🔵

**WHEN** 未読通知が存在する
**THEN** システム SHALL 通知ベルにバッジ数を表示し、未読項目をハイライトする 🔵

**WHEN** ユーザーが通知を既読にする
**THEN** システム SHALL seenAt タイムスタンプを記録し、UI 表示を更新する 🔵

#### AC-NOTIF-002-2: 通知設定
**WHEN** ユーザーが通知設定画面にアクセスする
**THEN** システム SHALL Web Push 有効化状況と登録済み端末リストを表示する 🔵

**WHEN** ユーザーが Web Push を有効化する
**THEN** システム SHALL ブラウザ許可を要求し、購読情報をサーバーに登録する 🔵

**WHEN** Expo Push トークンが更新される
**THEN** システム SHALL 新しいトークンを記録し、古いトークンを非アクティブ化する 🔵

**実装状況**: ✅ 完全実装済み、ユーザビリティ改善継続中

---

## マルチプラットフォーム UI

### AC-UI-001: レスポンシブ Web デザイン 🔵

#### AC-UI-001-1: ブレークポイント対応
**WHEN** 画面幅が 1440px 以上（Desktop）である
**THEN** システム SHALL 左サイドバー（240px幅）+ メインコンテンツレイアウトを表示する 🔵

**WHEN** 画面幅が 1024px-1439px（Tablet）である
**THEN** システム SHALL サイドバーを収納し、トップナビゲーションに集約表示する 🔵

**WHEN** 画面幅が 375px-1023px（Mobile）である
**THEN** システム SHALL Bottom Tabs + Top App Bar レイアウトに切り替える 🔵

#### AC-UI-001-2: ロール別 UI 差分
**WHEN** Requester ロールでアクセスする
**THEN** システム SHALL 「エスクロー作成」CTA を強調し、承認ボタンを非表示にする 🔵

**WHEN** Approver ロールでアクセスする
**THEN** システム SHALL 「承認キューへ」CTA を強調し、承認待ち件数をバッジ表示する 🔵

**WHEN** Owner ロールでアクセスする
**THEN** システム SHALL 「設定」CTA とシステム監視情報を表示する 🔵

**WHEN** Viewer ロールでアクセスする
**THEN** システム SHALL 読み取り専用モードで操作ボタンを非活性化表示する 🔵

**実装状況**: ✅ レスポンシブレイアウト実装済み、ロール別最適化は継続改善中

### AC-UI-002: モバイルアプリ UX 🟡

#### AC-UI-002-1: タブナビゲーション
**WHEN** モバイルアプリが起動する
**THEN** システム SHALL Home/Scan/Timeline/Settings の4タブを底部に表示する 🔵

**WHEN** ユーザーがタブを切り替える
**THEN** システム SHALL スムーズなアニメーションで画面遷移し、状態を保持する 🔵

**WHEN** 重要な操作ボタンが表示される
**THEN** システム SHALL 親指の届く範囲（画面下部1/3）に配置する 🔵

#### AC-UI-002-2: ネイティブ機能統合
**WHEN** ユーザーが Scan タブにアクセスする
**THEN** システム SHALL カメラ権限を要求し、QR スキャナーを起動する 🟡

**WHEN** 承認用 QR コードがスキャンされる
**THEN** システム SHALL エスクロー情報をデコードし、承認画面に遷移する 🟡

**WHEN** プッシュ通知がタップされる
**THEN** システム SHALL 適切な画面（エスクロー詳細等）に直接遷移する 🔵

**実装状況**: ✅ 基本ナビゲーション実装済み、QR機能は部分実装、通知統合は完了

### AC-UI-003: ワイヤーフレーム準拠 🔵

#### AC-UI-003-1: コンポーネント構成
**WHEN** システムがレンダリングされる
**THEN** システム SHALL wireframe-brief.md で定義されたコンポーネント階層に準拠する 🔵

**WHEN** KPI カードが表示される
**THEN** システム SHALL 承認待ち件数・期限迫るエスクロー・Paymaster残高・通知配送率を表示する 🔵

**WHEN** エスクロー詳細が表示される
**THEN** システム SHALL 基本情報・タイムライン・承認アクション・監査セクションを配置する 🔵

#### AC-UI-003-2: インタラクション設計
**WHEN** 重要操作（承認/キャンセル）が実行される
**THEN** システム SHALL 確認モーダル + ロール確認 + スポンサー結果表示のフローを実行する 🔵

**WHEN** API レスポンスが遅延する
**THEN** システム SHALL プログレッシブローディング（Skeleton UI）を表示する 🔵

**WHEN** ネットワークエラーが発生する
**THEN** システム SHALL バナー通知とリトライボタンを表示する 🔵

**実装状況**: ✅ ワイヤーフレーム準拠、インタラクション改善継続中

---

## セキュリティ・品質基準

### AC-SEC-001: 認証・認可 🔵

#### AC-SEC-001-1: ウォレット認証
**WHEN** ユーザーがシステムにアクセスする
**THEN** システム SHALL WalletConnect 経由でウォレット署名ベース認証を要求する 🔵

**WHEN** 署名検証が成功する
**THEN** システム SHALL JWT トークンを発行し、セッション管理を開始する 🔵

**WHEN** セッションが有効期限切れになる
**THEN** システム SHALL 自動的に再認証フローを促し、継続的なアクセスを保護する 🔵

#### AC-SEC-001-2: API セキュリティ
**WHEN** 全ての API エンドポイントが呼び出される
**THEN** システム SHALL Bearer トークン検証を実行し、無効時は 401 エラーを返す 🔵

**WHEN** ロール制限 API が呼び出される
**THEN** システム SHALL 要求ロールレベルと現在権限を照合し、不足時は 403 エラーを返す 🔵

**実装状況**: ✅ 基本認証実装済み、詳細権限制御は改善継続中

### AC-SEC-002: データ保護 🔵

#### AC-SEC-002-1: 暗号化
**WHEN** 機密データがデータベースに保存される
**THEN** システム SHALL AES-256-GCM で暗号化し、キーローテーションをサポートする 🔵

**WHEN** 通信が行われる
**THEN** システム SHALL HTTPS/TLS 1.3 を強制し、平文通信を拒否する 🔵

**WHEN** プライベートキー情報が処理される
**THEN** システム SHALL サーバーサイドに保存せず、クライアント署名のみ要求する 🔵

**実装状況**: ✅ 基本暗号化実装済み、キー管理は継続改善中

### AC-PERF-001: パフォーマンス要件 🔵

#### AC-PERF-001-1: レスポンス時間
**WHEN** ダッシュボードが初回表示される
**THEN** システム SHALL 3秒以内に初期コンテンツを表示する 🔵

**WHEN** エスクロー操作が実行される
**THEN** システム SHALL 2秒以内にレスポンスを返し、ユーザーフィードバックを提供する 🔵

**WHEN** The Graph クエリが実行される
**THEN** システム SHALL 1秒以内にデータを取得し、キャッシュ戦略を適用する 🟡

#### AC-PERF-001-2: スケーラビリティ
**WHEN** 同時接続ユーザーが100人に達する
**THEN** システム SHALL レスポンス時間の劣化を20%以内に抑制する 🔵

**WHEN** 1日あたり1,000件のエスクローが処理される
**THEN** システム SHALL データベース性能を維持し、適切なインデックス戦略を適用する 🔵

**実装状況**: ✅ 基本性能要件達成、スケーラビリティ最適化は継続改善中

---

## 成功基準マトリックス

### 機能完成度指標

| カテゴリ | 完全実装 🔵 | 部分実装 🟡 | 未実装 🔴 | 合計達成率 |
|----------|-------------|-------------|-----------|------------|
| **エスクロー管理** | 65% | 25% | 10% | **85%** |
| **ロール・権限** | 40% | 35% | 25% | **70%** |
| **Account Abstraction** | 20% | 45% | 35% | **55%** |
| **通知システム** | 80% | 15% | 5% | **90%** |
| **UI/UX** | 75% | 20% | 5% | **90%** |
| **セキュリティ** | 70% | 25% | 5% | **85%** |

### 技術品質指標

| 指標 | 目標値 | 現在値 | 達成状況 |
|------|--------|--------|----------|
| **ユニットテストカバレッジ** | >80% | 65% | 🟡 |
| **E2Eテストカバレッジ** | >70% | 40% | 🔴 |
| **API レスポンス時間** | <2秒 | 1.2秒 | 🔵 |
| **UI 初期表示時間** | <3秒 | 2.8秒 | 🔵 |
| **通知配信成功率** | >95% | 92% | 🟡 |
| **セキュリティ脆弱性** | 0件 | 2件(Low) | 🟡 |

---

**信頼性指標**:
- 🔵 高信頼性: 実装済み、テスト済み、または実証された基準
- 🟡 中信頼性: 部分実装、仕様明確、または改善継続中の基準
- 🔴 低信頼性: 未実装、仕様不明確、または技術的課題がある基準

**最終更新**: 2025-09-29
**承認者**: [要承認]
**次回レビュー**: kairo-design 完了後